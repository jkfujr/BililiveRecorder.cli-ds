<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>录播姬状态捏</title>
    <!-- Bootstrap5、popperjs、Font Awesome -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.15.4/css/all.css" crossorigin="anonymous">
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
</head>

<style>
    /* 整体框架 */
    body {
        /* 随机二刺螈图 */
        background-image: url("https://www.loliapi.com/acg/pc/");
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center top;
        font-family: "Microsoft YaHei";
    }



    /* 主内容区-框架 */
    .main-frame {
        position: fixed;
        top: 6.5%;
        bottom: 0;
        right: 0;
        width: 85.5%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.50);
        box-shadow:
            inset 0rem 0rem .625rem rgba(0, 0, 0, 0.1),
            inset .3125rem .3125rem .3125rem rgba(0, 0, 0, 0.1);
        /* 不允许任何溢出的内容展现在元素之外 */
        overflow-y: hidden;
        /* 层级1 */
        z-index: 1;
    }




    /* 侧边栏-框架，并作为容器包含"搜索框"、"数据面板"、"侧边栏" */
    .sidebar-frame {
        position: fixed;
        top: 6.5%;
        bottom: 0;
        left: 0;
        width: 14.5%;
        max-width: 14.5%;
        padding: 0;
        background-color: rgba(255, 255, 255, 0.8);
        border-right: .0313rem solid rgba(51, 54, 57, 0.5);
        /* 层级3 */
        z-index: 3;
    }

    /* 侧边栏-搜索框 */
    .sidebar-search {
        position: fixed;
        top: 4.5rem;
        left: 0;
        width: 14.5%;
        display: block;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #ff0000;
        background-color: rgba(255, 255, 255, 0.5);
        background-clip: padding-box;
        appearance: none;
        border: .0625rem solid rgba(0, 0, 0, 0.25);
        /* 层级2 */
        z-index: 2;
    }


    /* 侧边栏-数据面板 */
    #sidebar-datapanel {
        position: fixed;
        top: 7.5rem;
        left: 0;
        width: 14.5%;
        display: block;
        padding: .375rem .75rem;
        color: #212529;
        border-radius: .3125rem;
        font-size: 1.5625rem;
        background-color: rgba(255, 255, 255, 0.5);
        background-clip: padding-box;
        border: .0625rem solid rgba(0, 0, 0, 0.25);
        /* 层级2 */
        z-index: 2;
    }



    /* 侧边栏 */
    .sidebar {
        position: fixed;
        top: 13.5625rem;
        left: 0;
        width: 14.45%;
        display: block;
        height: calc(100%);
        /* 如果内容超出高度，显示滚动条 */
        overflow-y: auto;
        background-color: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(.5rem);
        border-top: .0625rem solid rgba(0, 0, 0, 0.5);
        /* 层级2 */
        z-index: 2;
    }

    /* 侧边栏-侧边栏链接添加过渡效果 */
    /* 有些许抖动，在意就自己注释掉 */
    .sidebar a {
        transition: all 0.3s ease-in-out;
    }

    /* 侧边栏-鼠标悬浮于侧边栏链接上时，将链接文字变成白色，并设定背景颜色与透明度 */
    .sidebar a:hover {
        color: rgb(255, 255, 255);
        background-color: rgb(108, 117, 125);
    }


    /* 侧边栏-数据-tag */
    sidebar-data-tag {
        float: right;
        font-size: .625rem;
        height: 1.25rem;
        line-height: 1.25rem;
        padding: 0 .5rem;
        margin-left: .5rem;
        border-radius: .625rem;
        font-weight: 700;
    }

    /* 侧边栏-数据-tag-直播中 */
    .sidebar-data-tag-streaming {
        background-color: rgba(255, 0, 0, 0.8);
        color: #fff;

    }

    /* 侧边栏-数据-tag-摸鱼中 */
    .sidebar-data-tag-not-streaming {
        background-color: rgba(0, 128, 0, 0.8);
        color: #fff;
    }

    /* 侧边栏-滚动条 */
    .sidebar::-webkit-scrollbar {
        width: .625rem;
        height: .625rem;
    }

    /* 侧边栏-滚动条-轨道 */
    .sidebar::-webkit-scrollbar-track {
        background-color: rgb(245, 245, 245);
    }

    /* 侧边栏-滚动条-滑块 */
    .sidebar::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: .3125rem;
    }

    /* 侧边栏-滚动条-滑块-拖动状态下动画 */
    .sidebar::-webkit-scrollbar-thumb:hover {
        background-color: rgba(0, 0, 0, 0.3);
    }



    /* 导航栏 */
    .navbar {
        position: fixed;
        /* 固定导航栏在页面顶部 */
        top: 0;
        left: 0;
        width: 100%;
        height: 3.875rem;
        padding: 0;
        /* 层级4 */
        z-index: 4;
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(.5rem);
        border-bottom: .0313rem solid rgba(51, 54, 57, 0.5);
    }
</style>

<script>
    /* 导根据录播姬ID获取详细数据 */
    function getLiveRoomData(id) {
        // 发送请求获取单独直播间的数据
        fetch(`/api/${id}`)
            .then(response => response.json())
            // 处理数据，在该函数内渲染详细数据
            .then(data => {
                document.getElementById('liveRoomTitle').innerText = data['直播间标题'];
                document.getElementById('streaming').innerText = '直播状态:' + (data['直播状态'] ? '直播中' : '摸鱼中');
                document.getElementById('recording').innerText = '录制状态:' + (data['录制状态'] ? '录制中' : '监控中');
            });
    }

    /* 切换侧边栏的选中状态 */
    function changeActiveItem(item) {
        const activeItem = document.querySelector('.sidebar .active');
        if (activeItem) {
            activeItem.classList.remove('active');
        }
        item.classList.add('active');
    }

    /* 等待页面加载完成执行 */
    document.addEventListener('DOMContentLoaded', () => {

        // 获取数据
        const data = JSON.parse('{{ data | tojson }}');

        // 渲染侧边栏
        const sidebar = document.querySelector('.sidebar');

        // 按照用户名排序
        const sortedData = data.sort((a, b) => a['用户名'].localeCompare(b['用户名']));

        // 声明一个用于存储有 '录制中' 或 '摸鱼中' TAG的直播房间的数组
        let listedData = [];

        /* 在原数据的上添加对应的TAG*/
        for (let idx = 0; idx < sortedData.length; idx++) {
            let currentData = sortedData[idx];
            currentData.isStreaming = currentData['直播状态'] === true;

            let tag = document.createElement('sidebar-data-tag');
            let icon = document.createElement('i');

            tag.classList.add('tag');
            icon.classList.add('fas');
            icon.classList.add('fa-video');
            icon.classList.add('fa-xs');

            if (currentData.isStreaming) {
                tag.classList.add('sidebar-data-tag-streaming');
                icon.classList.add('fa-video');
                tag.appendChild(icon);
                tag.appendChild(document.createTextNode(''));
            } else {
                tag.classList.add('sidebar-data-tag-not-streaming');
                icon.classList.add('fa-times');
                tag.appendChild(icon);
                tag.appendChild(document.createTextNode(''));
            }

            // 项目标题与TAG之间增加一个'空格'作为分隔符
            currentData['用户名'] = currentData['用户名'] + ' ';
            // 将TAG增加到项目标题中 */
            currentData.taggedUsername = currentData['用户名'] + tag.outerHTML;
            // 将更新后的直播房间信息存放到已标记数组中 */
            listedData.push(currentData);
        }

        /* 对正在直播中的V，优先进行排列（按A-Z用户名排序） */
        const sortedListedData = listedData
            .filter(item => item.isStreaming)
            .sort((a, b) => {
                return a['用户名']
                    .localeCompare(b['用户名'], ['en', 'ja', 'zh'], { sensitivity: 'base' })
            })
            .concat(
                listedData
                    .filter(item => !item.isStreaming)
                    .sort((a, b) => {
                        return a['用户名']
                            .localeCompare(b['用户名'], ['en', 'ja', 'zh'], { sensitivity: 'base' })
                    })
            );
        /* 遍历排序后的列表渲染侧边栏 */
        for (let liveRoom of sortedListedData) {
            const item = document.createElement('a');
            item.classList.add('list-group-item', 'list-group-item-action' );
            // 从更新后的数据中渲染项目标题（含TAG）
            item.innerHTML = liveRoom.taggedUsername;
            item.addEventListener('click', () => {
                changeActiveItem(item);
                getLiveRoomData(liveRoom['录播姬ID']);
            });
            sidebar.appendChild(item);
        }

        // 创建搜索框元素
        const sidebarFrame = document.getElementById('sidebar-frame');
        const searchBox = document.createElement('input');
        searchBox.type = 'search';
        searchBox.placeholder = '搜索用户名';
        searchBox.classList.add('form-control', 'mb-3', 'sidebar-search');
        searchBox.autocomplete = 'off';
        sidebarFrame.insertBefore(searchBox, sidebarFrame.firstChild);


        /* 数据面板 */
        // 计算所有直播间数量和正在直播中的直播间数量
        const totalRooms = data.length;
        const liveRooms = data.filter(room => room['直播状态']).length;
        // 计算用户名的数量
        const totalUsernames = data.reduce((total, room) => {
            return total + room['用户名'].split(',').length;
        }, 0);
        // 将数据渲染到数据面板中
        document.getElementById('total-rooms').textContent = totalRooms;
        document.getElementById('live-rooms').textContent = liveRooms;
    });
</script>

<body>
    <!-- 导航栏 -->
    <!-- <nav class="navbar">
        <h5 class="navbar-brand">录播姬状态捏</h5>
        <a class="navbar-url" href="https://www.bilibili.com/">测试一下导航栏连接样式</a>
    </nav> -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">录播姬状态捏</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
              <a class="nav-link active" aria-current="page" href="#">测测</a>
              <a class="nav-link" href="#">你</a>
              <a class="nav-link" href="#">的</a>
              <a class="nav-link" href="#">测试</a>
            </div>
          </div>
        </div>
      </nav>
    <!-- 侧边栏-框架 -->
    <div class="sidebar-frame" id="sidebar-frame">
        <!-- 数据面板 -->
        <div id="sidebar-datapanel">
            <div><i class="fas fa-eye"></i>监控中：<span id="total-rooms"></span></div>
            <div><i class="fas fa-play-circle"></i>直播中：<span id="live-rooms"></span></div>
        </div>
        <!-- 侧边栏 -->
        <div class="sidebar">
        </div>
    </div>

    <!-- 主内容区-框架 -->
    <div class="main-frame">
        <!-- 主内容区-详细数据 -->
        <div class="main-frame-data">
            <!-- 主内容区-详细数据-直播间标题 -->
            <h2 class="fs-1" id="liveRoomTitle"></h2>
            <!-- 主内容区-详细数据-直播状态 -->
            <div class="row mb-3">
                <div class="main-frame-data-text" id="streaming"></div>
            </div>
            <!-- 主内容区-详细数据-录制状态 -->
            <div class="row mb-3">
                <div class="col" id="recording"></div>
            </div>
        </div>
    </div>

    <!-- 引用jQuery，放在外面保证能够引用 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- JS，放在最后进行事件绑定 -->
    <script>
        $(function () {
            const sidebarframeItems = $('.sidebar-frame a.list-group-item');
            const searchBox = $('.sidebar-frame input[type="search"]');
            searchBox.on('input', () => {
                const keyword = searchBox.val().trim();
                if (!keyword) {
                    sidebarframeItems.show();
                } else {
                    sidebarframeItems.hide().filter((_, item) => {
                        let allLowerCaseText = $(item).text().trim().toLowerCase();
                        // 分别将中英文的全角和半角字符进行替换
                        allLowerCaseText = allLowerCaseText.replace(/[^\x00-\xff]/g, (char) => {
                            let charCode = char.charCodeAt(0);
                            if (charCode === 12288) {
                                return String.fromCharCode(32);
                            } else if (charCode > 65280 && charCode < 65375) {
                                return String.fromCharCode(charCode - 65248);
                            }
                            return char;
                        });
                        let allLowerCaseKeyword = keyword.toLocaleLowerCase();
                        allLowerCaseKeyword = allLowerCaseKeyword.replace(/[^\x00-\xff]/g, (char) => {
                            let charCode = char.charCodeAt(0);
                            if (charCode === 12288) {
                                return String.fromCharCode(32);
                            } else if (charCode > 65280 && charCode < 65375) {
                                return String.fromCharCode(charCode - 65248);
                            }
                            return char;
                        });
                        return allLowerCaseText.indexOf(allLowerCaseKeyword) > -1;
                    }).show();
                }
            });
        });
    </script>
</body>

</html>