<!DOCTYPE html>
<html lang="zh-CN">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0,
      minimum-scale=1.0" />
    <title>录播姬状态捏</title>
    <!-- lcl css -->
    <link rel="stylesheet" href="../assets/css/min.css" />
    <!--bootstrap css-->
    <link rel="stylesheet" href="../assets/css/bootstrap/bootstrap.min.css"
      crossorigin="anonymous">
    <!--fontawesome js-->
    <script src="../assets/js/fontawesome/min.js" crossorigin="anonymous"></script>
    <!-- bootstrap js cdn -->
    <script src="../assets/js/bootstrap/bootstrap.bundle.js"
      crossorigin="anonymous"></script>
  </head>

  <style>
  /* 导航栏 */
  .navbar {
    position: fixed;
    /* 固定导航栏在页面顶部 */
    top: 0;
    left: 0;
    width: 100%;
    height: 3.875rem;
    padding: 0;
    /* 层级4 */
    z-index: 4;
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(.5rem);
    border-bottom: .0313rem solid rgba(51, 54, 57, 0.5);
  }
  </style>
  <script>

  /* 导根据录播姬ID获取详细数据 */
  function getLiveRoomData(id) {
    // 发送请求获取单独直播间的数据
    fetch(`/bililiveRec/api/${id}`)
      .then(response => response.json())
      // 处理数据，在该函数内渲染详细数据
      .then(data => {
        document.getElementById('liveRoomTitle').innerText = data['直播间标题'];
        let roomId = data['直播间ID'];
        let bililive = 'https://live.bilibili.com/' + roomId;
        document.getElementById('roomIdLink').innerHTML = '直播间ID:  <a href="' + bililive + '">' + roomId + '</a>';
        document.getElementById('streaming').innerText = '直播状态: ' + (data['直播状态'] ? '直播中' : '摸鱼中');
        document.getElementById('recording').innerText = '录制状态: ' + (data['录制状态'] ? '录制中' : '监控中');
      });
  }


  /* 切换侧边栏的选中状态 */
  function changeActiveItem(item) {
    const activeItem = document.querySelector('.sidebar .active');
    if (activeItem) {
      activeItem.classList.remove('active');
    }
    item.classList.add('active');
  }

  /* 等待页面加载完成执行 */
  document.addEventListener('DOMContentLoaded', () => {

    // 获取数据
    const data = JSON.parse('{{ data | tojson }}');

    // 渲染侧边栏
    const sidebar = document.querySelector('.sidebar');

    // 按照用户名排序
    const sortedData = data.sort((a, b) => a['用户名'].localeCompare(b['用户名']));

    // 声明一个用于存储有 '录制中' 或 '摸鱼中' TAG的直播房间的数组
    let listedData = [];

    /* 在原数据的上添加对应的TAG*/
    for (let idx = 0; idx < sortedData.length; idx++) {
      let currentData = sortedData[idx];
      currentData.isStreaming = currentData['直播状态'] === true;

      let tag = document.createElement('sidebar-data-tag');
      let icon = document.createElement('i');

      tag.classList.add('tag');
      if (currentData.isStreaming) {
        // 侧边栏-数据-tag-直播中-样式添加
        tag.classList.add('sidebar-data-tag-streaming');
        // 侧边栏-数据-tag-直播中-图标添加
        icon.classList.add('fa-solid', 'fa-video', "fa-fade");
        tag.appendChild(icon);
        tag.appendChild(document.createTextNode(''));
      } else {
        // 侧边栏-数据-tag-直播中-样式添加
        tag.classList.add('sidebar-data-tag-not-streaming');
        // 侧边栏-数据-tag-直播中-图标添加
        icon.classList.add('fa-solid', 'fa-video');
        tag.appendChild(icon);
        tag.appendChild(document.createTextNode(''));
      }

      // 项目标题与TAG之间增加一个'空格'作为分隔符
      currentData['用户名'] = currentData['用户名'] + ' ';
      // 将TAG增加到项目标题中 */
      currentData.taggedUsername = currentData['用户名'] + tag.outerHTML;
      // 将更新后的直播房间信息存放到已标记数组中 */
      listedData.push(currentData);
    }

    /* 对正在直播中的V，优先进行排列（按A-Z用户名排序） */
    const sortedListedData = listedData
      .filter(item => item.isStreaming)
      .sort((a, b) => {
        return a['用户名']
          .localeCompare(b['用户名'], ['en', 'ja', 'zh'], { sensitivity: 'base' })
      })
      .concat(
        listedData
          .filter(item => !item.isStreaming)
          .sort((a, b) => {
            return a['用户名']
              .localeCompare(b['用户名'], ['en', 'ja', 'zh'], { sensitivity: 'base' })
          })
      );
    /* 遍历排序后的列表渲染侧边栏 */
    for (let liveRoom of sortedListedData) {
      const item = document.createElement('a');
      item.classList.add('list-group-item');
      // 从更新后的数据中渲染项目标题（含TAG）
      item.innerHTML = liveRoom.taggedUsername;
      item.addEventListener('click', () => {
        changeActiveItem(item);
        getLiveRoomData(liveRoom['录播姬ID']);
      });
      sidebar.appendChild(item);
    }

    // 创建搜索框元素
    const sidebarFrame = document.getElementById('sidebar-frame');
    const searchBox = document.createElement('input');
    searchBox.type = 'search';
    searchBox.placeholder = '搜索用户名';
    searchBox.classList.add('sidebar-search');
    searchBox.autocomplete = 'off';
    sidebarFrame.insertBefore(searchBox, sidebarFrame.firstChild);


    /* 数据面板 */
    // 计算所有直播间数量和正在直播中的直播间数量
    const totalRooms = data.length;
    const liveRooms = data.filter(room => room['直播状态']).length;
    // 计算用户名的数量
    const totalUsernames = data.reduce((total, room) => {
      return total + room['用户名'].split(',').length;
    }, 0);
    // 将数据渲染到数据面板中
    document.getElementById('total-rooms').textContent = totalRooms;
    document.getElementById('live-rooms').textContent = liveRooms;
  });

</script>
  <body>
    <!-- 导航栏 -->
    <nav class="lcl_navbar navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">录播姬状态捏</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
          data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup" aria-expanded="false"
          aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link active" aria-current="page" href="#">测测</a>
            <a class="nav-link" href="#">你</a>
            <a class="nav-link" href="#">的</a>
            <a class="nav-link" href="#">测试</a>
          </div>
        </div>
      </div>
    </nav>
    <!-- 侧边栏-框架 -->
    <div class="sidebar-frame" id="sidebar-frame">
      <!-- 数据面板 -->
      <div id="sidebar-datapanel">
        <div><i class="fas fa-eye"></i>监控中：<span id="total-rooms"></span></div>
        <div><i class="fas fa-play-circle"></i>直播中：<span id="live-rooms"></span></div>
      </div>
      <!-- 侧边栏 -->
      <div class="sidebar">
      </div>
    </div>

    <!-- 主内容区-框架 -->
    <div class="main-frame">
      <!-- 主内容区-详细数据 -->
      <div class="main-frame-data">
        <!-- 主内容区-详细数据-直播间标题 -->
        <h2 class="fs-1" id="liveRoomTitle"></h2>
        <!-- 主内容区-详细数据-直播间ID -->

        <div class="fs-2" id="roomIdLink"></div>
        <!-- 主内容区-详细数据-直播状态 -->
        <div class="fs-2" id="streaming"> </div>
        <!-- 主内容区-详细数据-录制状态 -->
        <div class="fs-2" id="recording"></div>
      </div>
    </div>

    <!-- 引用jQuery，放在外面保证能够引用 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- JS，放在最后进行事件绑定 -->
    <script>
    $(function () {
      const sidebarframeItems = $('.sidebar-frame a.list-group-item');
      const searchBox = $('.sidebar-frame input[type="search"]');
      searchBox.on('input', () => {
        const keyword = searchBox.val().trim();
        if (!keyword) {
          sidebarframeItems.show();
        } else {
          sidebarframeItems.hide().filter((_, item) => {
            let allLowerCaseText = $(item).text().trim().toLowerCase();
            // 分别将中英文的全角和半角字符进行替换
            allLowerCaseText = allLowerCaseText.replace(/[^\x00-\xff]/g, (char) => {
              let charCode = char.charCodeAt(0);
              if (charCode === 12288) {
                return String.fromCharCode(32);
              } else if (charCode > 65280 && charCode < 65375) {
                return String.fromCharCode(charCode - 65248);
              }
              return char;
            });
            let allLowerCaseKeyword = keyword.toLocaleLowerCase();
            allLowerCaseKeyword = allLowerCaseKeyword.replace(/[^\x00-\xff]/g, (char) => {
              let charCode = char.charCodeAt(0);
              if (charCode === 12288) {
                return String.fromCharCode(32);
              } else if (charCode > 65280 && charCode < 65375) {
                return String.fromCharCode(charCode - 65248);
              }
              return char;
            });
            return allLowerCaseText.indexOf(allLowerCaseKeyword) > -1;
          }).show();
        }
      });
    });
  </script>
  </body>

</html>